<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ë°ì´íŠ¸ ë‚˜ì¹¨ë°˜</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=Space+Mono:wght@400;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --accent: #ff3c5f;
    --gold: #f5c842;
    --text: #e8e4dc;
    --muted: #4a4860;
    --glow: rgba(255,60,95,0.4);
    --green: #4ade80;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    user-select: none;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(255,60,95,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,60,95,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
  }

  /* ========== SHARED ========== */
  .screen {
    display: none;
    flex-direction: column;
    align-items: center;
    z-index: 10;
    width: 100%;
    max-width: 380px;
    padding: 28px 24px;
  }
  .screen.active { display: flex; }

  .heart-icon { font-size: 2.6rem; animation: heartbeat 1.5s ease-in-out infinite; margin-bottom: 4px; }
  @keyframes heartbeat { 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }

  .title-ko {
    font-family: 'Nanum Myeongjo', serif;
    font-size: clamp(2rem, 8vw, 3rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.15;
    text-align: center;
    margin-bottom: 4px;
  }
  .title-ko span { color: var(--accent); }

  .sub { font-size: 0.62rem; color: var(--muted); letter-spacing: 0.18em; text-transform: uppercase; }
  .desc { font-size: 0.73rem; color: var(--muted); max-width: 280px; line-height: 1.9; text-align: center; }

  /* ========== BUTTONS ========== */
  .btn-primary {
    background: var(--accent); color: #fff; border: none;
    font-family: 'Space Mono', monospace; font-size: 0.9rem; font-weight: 700;
    letter-spacing: 0.12em; padding: 15px; cursor: pointer;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
    transition: all 0.2s; text-transform: uppercase; width: 100%;
  }
  .btn-primary:hover, .btn-primary:active { background: #ff1a40; box-shadow: 0 0 24px var(--glow); }

  .btn-outline {
    background: transparent; color: var(--accent); border: 1px solid var(--accent);
    font-family: 'Space Mono', monospace; font-size: 0.72rem; font-weight: 700;
    letter-spacing: 0.12em; padding: 12px; cursor: pointer;
    clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
    transition: all 0.2s; text-transform: uppercase; width: 100%;
  }
  .btn-outline:hover, .btn-outline:active { background: var(--accent); color: #fff; box-shadow: 0 0 20px var(--glow); }

  /* ========== START SCREEN ========== */
  #start-screen { gap: 20px; text-align: center; }

  .section-label {
    font-size: 0.58rem; color: var(--muted); letter-spacing: 0.2em;
    text-transform: uppercase; text-align: left; width: 100%;
  }

  /* Radius selector */
  .radius-wrap { display: flex; gap: 8px; width: 100%; }
  .radius-btn {
    flex: 1; background: var(--surface); border: 1px solid var(--muted);
    color: var(--muted); font-family: 'Space Mono', monospace; font-size: 0.68rem;
    letter-spacing: 0.08em; padding: 10px 0; cursor: pointer;
    clip-path: polygon(5px 0%, 100% 0%, calc(100% - 5px) 100%, 0% 100%);
    transition: all 0.15s; text-align: center;
  }
  .radius-btn.active { background: rgba(255,60,95,0.15); border-color: var(--accent); color: var(--accent); }

  .options-wrap { display: flex; flex-direction: column; gap: 10px; width: 100%; }

  /* ========== GAME SCREEN ========== */
  #game-screen {
    justify-content: space-between;
    height: 100dvh;
    padding: 44px 24px 36px;
    gap: 0;
  }

  .top-info { display: flex; flex-direction: column; align-items: center; gap: 6px; }

  .distance-display {
    font-size: clamp(2.8rem, 13vw, 4.5rem);
    font-weight: 700; letter-spacing: -0.03em; line-height: 1;
  }
  .distance-display .unit { font-size: 0.38em; color: var(--muted); letter-spacing: 0.1em; }
  .distance-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.2em; text-transform: uppercase; }

  .status-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
    display: inline-block; margin-right: 6px;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

  /* Compass */
  .compass-wrap {
    position: relative;
    width: min(270px, 72vw); height: min(270px, 72vw);
    display: flex; align-items: center; justify-content: center;
  }
  .compass-ring { position: absolute; inset: 0; border-radius: 50%; border: 1px solid rgba(255,60,95,0.2); }
  .compass-ring::before { content:''; position:absolute; inset:12px; border-radius:50%; border:1px solid rgba(255,60,95,0.1); }
  .compass-inner { position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  #arrow-container { position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  .arrow-svg {
    width:58%; height:58%;
    filter: drop-shadow(0 0 14px var(--accent)) drop-shadow(0 0 28px rgba(255,60,95,0.3));
  }
  .center-dot { position:absolute; width:10px; height:10px; background:var(--gold); border-radius:50%; box-shadow:0 0 8px var(--gold); z-index:5; }
  .cardinal { position:absolute; font-size:0.6rem; color:var(--muted); letter-spacing:.1em; }
  .cardinal.n { top:4px; left:50%; transform:translateX(-50%); }
  .cardinal.s { bottom:4px; left:50%; transform:translateX(-50%); }
  .cardinal.e { right:4px; top:50%; transform:translateY(-50%); }
  .cardinal.w { left:4px; top:50%; transform:translateY(-50%); }

  /* Bottom controls */
  .bottom-controls { display:flex; flex-direction:column; align-items:center; gap:10px; width:100%; }

  #compass-btn {
    background: rgba(255,60,95,0.12); border: 1px solid var(--accent); color: var(--accent);
    font-family: 'Space Mono', monospace; font-size: 0.68rem; letter-spacing: 0.1em;
    padding: 12px 24px; cursor: pointer;
    clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
    display: none;
  }

  .hint-text { font-size:0.6rem; color:var(--muted); letter-spacing:.15em; text-transform:uppercase; display:none; }

  /* Test reveal */
  .test-row { display:flex; align-items:center; gap:8px; }
  #test-toggle-btn {
    background: transparent; border: 1px dashed var(--muted); color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 0.58rem; letter-spacing: 0.1em;
    padding: 7px 14px; cursor: pointer;
    clip-path: polygon(4px 0%, 100% 0%, calc(100% - 4px) 100%, 0% 100%);
    transition: all 0.15s; text-transform: uppercase; white-space: nowrap;
  }
  #test-toggle-btn.revealed { border-color: rgba(245,200,66,0.5); color: var(--gold); }

  #dest-box {
    display: none;
    font-family: 'Nanum Myeongjo', serif;
    font-size: 0.82rem; color: var(--gold);
    text-align: center; line-height: 1.6;
    padding: 8px 14px;
    border: 1px dashed rgba(245,200,66,0.3);
    background: rgba(245,200,66,0.05);
    width: 100%;
  }
  #dest-box .dest-addr { font-family: 'Space Mono', monospace; font-size: 0.58rem; color: var(--muted); display:block; margin-top:3px; }

  /* ========== 50m ALERT BANNER ========== */
  #near-alert {
    display: none;
    position: fixed; top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(74,222,128,0.05));
    border-bottom: 1px solid var(--green);
    z-index: 30;
    padding: 14px 20px;
    flex-direction: column; align-items: center; gap: 10px;
  }
  .near-title { font-size: 0.72rem; color: var(--green); letter-spacing: 0.15em; text-transform: uppercase; }
  .near-title .near-dot { display:inline-block; width:7px; height:7px; background:var(--green); border-radius:50%; margin-right:7px; animation: pulse 1s ease-in-out infinite; }

  #near-reveal-btn {
    background: rgba(74,222,128,0.15); border: 1px solid var(--green); color: var(--green);
    font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 0.12em;
    padding: 9px 20px; cursor: pointer;
    clip-path: polygon(5px 0%, 100% 0%, calc(100% - 5px) 100%, 0% 100%);
    transition: all 0.2s; text-transform: uppercase;
  }
  #near-reveal-btn:hover { background: rgba(74,222,128,0.3); }

  #near-name-box {
    display: none;
    font-family: 'Nanum Myeongjo', serif;
    font-size: 1.1rem; color: var(--green);
    text-align: center; line-height: 1.6;
    padding: 8px 16px;
    border: 1px solid rgba(74,222,128,0.3);
    background: rgba(74,222,128,0.08);
    width: 100%;
    max-width: 300px;
  }

  /* ========== LOADING ========== */
  #loading-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(10,10,15,0.92); z-index: 50;
    flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  }
  .loader-ring { width:52px; height:52px; border:2px solid var(--muted); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loader-text { font-size:0.68rem; color:var(--muted); letter-spacing:.15em; text-transform:uppercase; }

  /* ========== TOAST ========== */
  #toast {
    display: none; position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: rgba(255,60,95,0.15); border: 1px solid var(--accent); color: var(--accent);
    font-size: 0.63rem; letter-spacing: .1em; padding: 10px 20px; z-index: 100; white-space: nowrap;
  }

  /* ========== ARRIVAL SCREEN ========== */
  #arrival-screen { gap: 16px; text-align: center; }
  .arrival-emoji { font-size: 3rem; }
  .arrival-title { font-family:'Nanum Myeongjo',serif; font-size:clamp(1.8rem,7vw,2.6rem); font-weight:700; color:var(--gold); text-shadow:0 0 24px rgba(245,200,66,0.4); line-height:1.2; }
  .place-badge { font-size:.58rem; color:var(--accent); letter-spacing:.2em; text-transform:uppercase; border:1px solid var(--accent); padding:5px 14px; clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%); }
  .place-reveal { font-family:'Nanum Myeongjo',serif; font-size:clamp(1.4rem,5.5vw,2rem); color:var(--text); line-height:1.3; }
  .place-address { font-size:.63rem; color:var(--muted); max-width:280px; line-height:1.8; }
  .btn-row { display:flex; gap:10px; width:100%; max-width:300px; }
  .btn-row .btn-outline { flex:1; }

  #confetti-canvas { position:fixed; inset:0; pointer-events:none; z-index:5; }
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div id="loading-overlay"><div class="loader-ring"></div><div class="loader-text" id="loader-text">ìœ„ì¹˜ í™•ì¸ ì¤‘...</div></div>
<div id="toast"></div>

<!-- 50m ê·¼ì ‘ ì•Œë¦¼ ë°°ë„ˆ -->
<div id="near-alert">
  <div class="near-title"><span class="near-dot"></span>ê±°ì˜ ë‹¤ ì™”ì–´ìš”! 50m ì´ë‚´</div>
  <button id="near-reveal-btn" onclick="toggleNearName()">â˜• ì¹´í˜ ì´ë¦„ ë³´ê¸°</button>
  <div id="near-name-box"></div>
</div>

<!-- ========== START ========== -->
<div id="start-screen" class="screen active">
  <div class="heart-icon">ğŸ’˜</div>
  <div class="title-ko">ëª°ë˜<br><span>ë°ì´íŠ¸</span><br>ë‚˜ì¹¨ë°˜</div>
  <p class="desc">ëª©ì ì§€ëŠ” ë¹„ë°€ âœ¦ í™”ì‚´í‘œë§Œ ë¯¿ê³  ê±¸ì–´ê°€ì„¸ìš”</p>

  <div class="options-wrap">
    <div class="section-label">ğŸ“ íƒìƒ‰ ë°˜ê²½</div>
    <div class="radius-wrap">
      <button class="radius-btn active" data-r="1000" onclick="selectRadius(this)">1 km</button>
      <button class="radius-btn" data-r="2000" onclick="selectRadius(this)">2 km</button>
      <button class="radius-btn" data-r="3000" onclick="selectRadius(this)">3 km</button>
    </div>
  </div>

  <button class="btn-primary" onclick="startGame()">ì¶œë°œí•˜ê¸° â†’</button>
  <div class="sub">ì—°ë‚¨ë™ Â· í™ëŒ€ ì¹´í˜ 60ê³³ ìˆ˜ë¡</div>
</div>

<!-- ========== GAME ========== -->
<div id="game-screen" class="screen">
  <div class="top-info">
    <div class="distance-display">
      <span id="dist-value">---</span><span class="unit" id="dist-unit"> m</span>
    </div>
    <div class="distance-label"><span class="status-dot"></span>ëª©ì ì§€ê¹Œì§€</div>
  </div>

  <div class="compass-wrap">
    <div class="compass-ring"></div>
    <div class="compass-inner">
      <span class="cardinal n">N</span>
      <span class="cardinal s">S</span>
      <span class="cardinal e">E</span>
      <span class="cardinal w">W</span>
      <div id="arrow-container">
        <svg class="arrow-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <polygon points="50,8 62,55 50,48 38,55" fill="#ff3c5f"/>
          <polygon points="50,92 62,55 50,62 38,55" fill="#2a1020"/>
          <circle cx="50" cy="55" r="6" fill="#ff3c5f" opacity="0.5"/>
        </svg>
      </div>
      <div class="center-dot"></div>
    </div>
  </div>

  <div class="bottom-controls">
    <button id="compass-btn" onclick="askCompassPermission()">ğŸ“± ì—¬ê¸° ëˆŒëŸ¬ì„œ ë‚˜ì¹¨ë°˜ í—ˆìš©</button>
    <div class="hint-text" id="hint-text">í™”ì‚´í‘œ ë°©í–¥ìœ¼ë¡œ ê±¸ì–´ê°€ì„¸ìš”</div>

    <!-- í…ŒìŠ¤íŠ¸ìš© ëª©ì ì§€ ë³´ê¸° -->
    <div class="test-row">
      <button id="test-toggle-btn" onclick="toggleDestination()">ğŸ” ëª©ì ì§€ ë³´ê¸°</button>
    </div>
    <div id="dest-box"></div>
  </div>
</div>

<!-- ========== ARRIVAL ========== -->
<div id="arrival-screen" class="screen">
  <div class="arrival-emoji">ğŸ‰</div>
  <div class="arrival-title">ë„ì°©í–ˆì–´ìš”!</div>
  <div class="place-badge" id="place-type-reveal">ì¹´í˜ â˜•</div>
  <div class="place-reveal" id="place-name-reveal"></div>
  <div class="place-address" id="place-address-reveal"></div>
  <div class="btn-row">
    <button class="btn-outline" onclick="openMaps()">ì§€ë„ ë³´ê¸°</button>
    <button class="btn-outline" onclick="restartGame()">ë‹¤ì‹œ ë½‘ê¸°</button>
  </div>
</div>

<script>
// ============================================================
// CAFE DATABASE â€” ì—°ë‚¨ë™ 30ê³³ + í™ëŒ€ 30ê³³
// ============================================================
const CAFES = [
  // â”€â”€ ì—°ë‚¨ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name:"ì—°ë‚¨ë°©ì•—ê°„", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 57", lat:37.5607, lng:126.9246 },
  { name:"ì¹´í˜ ë…¸í‹°ë“œ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 242", lat:37.5591, lng:126.9211 },
  { name:"ì–´ë‹ˆì–¸ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ29ê¸¸ 19", lat:37.5630, lng:126.9230 },
  { name:"ë ˆì´ì–´ë“œ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 25", lat:37.5593, lng:126.9242 },
  { name:"í•œë‚¨ì»¤í”¼ ì—°ë‚¨ì ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 254", lat:37.5588, lng:126.9218 },
  { name:"ì¹´í˜ ì½”ì½”ë„›ë°•ìŠ¤", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ1ê¸¸ 36", lat:37.5615, lng:126.9251 },
  { name:"ì‹ë¬¼ì¹´í˜ í¼ë¸”ë¦­ê°€ë“ ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 148", lat:37.5641, lng:126.9221 },
  { name:"ì—°ë‚¨ì‚´ë¡±", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 73", lat:37.5612, lng:126.9248 },
  { name:"ì¹´í˜ ë”œì¿ ìƒ¤", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 236", lat:37.5585, lng:126.9208 },
  { name:"ì„¼í„°ì»¤í”¼ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ5ê¸¸ 22", lat:37.5618, lng:126.9256 },
  { name:"ì—ì´ë°”ìš°íŠ¸ì»¤í”¼ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ29ê¸¸ 24", lat:37.5634, lng:126.9228 },
  { name:"ì¹´í˜ í…ì¦ˆ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 248", lat:37.5589, lng:126.9213 },
  { name:"ìš”ì´ë•… ì»¤í”¼", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 45", lat:37.5600, lng:126.9244 },
  { name:"ìŠ¤ëª°ë¹…ì»¤í”¼ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 141", lat:37.5638, lng:126.9218 },
  { name:"ì¹´í˜ íŒŒì´ë¸Œì–¼ë¼ì´ë¸Œ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ3ê¸¸ 12", lat:37.5609, lng:126.9252 },
  { name:"ë” ì½˜í¬ë¦¬íŠ¸ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 260", lat:37.5592, lng:126.9222 },
  { name:"ì¹´í˜ ë´„ë‚ ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ27ê¸¸ 8", lat:37.5626, lng:126.9234 },
  { name:"ì—ìŠ¤í”„ë ˆì†Œ ë„¤ì´í‹°ë¸Œ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 61", lat:37.5609, lng:126.9247 },
  { name:"ì¹´í˜ ì¸ë”ê°€ë“ ", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 155", lat:37.5644, lng:126.9225 },
  { name:"ë¡œì–„ë°€í¬í‹° ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 244", lat:37.5590, lng:126.9212 },
  { name:"ì¹´í˜ ë¯¸ë‡½", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ7ê¸¸ 4", lat:37.5621, lng:126.9258 },
  { name:"ê·¸ë¼ìš´ë“œ ì»¤í”¼ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ31ê¸¸ 14", lat:37.5635, lng:126.9240 },
  { name:"ì¹´í˜ ì˜¨ë„", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 51", lat:37.5603, lng:126.9245 },
  { name:"ë¸”ë£¨ë³´í‹€ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 252", lat:37.5591, lng:126.9216 },
  { name:"ì¹´í˜ ì‹ë¬¼ë„ê°", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 144", lat:37.5640, lng:126.9220 },
  { name:"í˜ì´í¼ê°€ë“  ì»¤í”¼", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ 79", lat:37.5615, lng:126.9250 },
  { name:"ì¹´í˜ êµ¬ìŠ¬", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 238", lat:37.5586, lng:126.9210 },
  { name:"ë”ì›¨ì´ë¸Œì»¤í”¼ ì—°ë‚¨", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ29ê¸¸ 18", lat:37.5632, lng:126.9227 },
  { name:"ì¹´í˜ ëª¨ë¦¬", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì—°ë‚¨ë¡œ2ê¸¸ 9", lat:37.5605, lng:126.9253 },
  { name:"íˆë“ íŠ¸ë™ ì»¤í”¼", area:"ì—°ë‚¨ë™", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 150", lat:37.5642, lng:126.9222 },

  // â”€â”€ í™ëŒ€ì…êµ¬ì—­ ê·¼ì²˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name:"ì¹´í˜ ë…¸í‹°ë“œ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 94", lat:37.5545, lng:126.9239 },
  { name:"ì—°ë‚¨ì¥ ì»¤í”¼", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ìš¸ë§ˆë‹¹ë¡œ 130", lat:37.5560, lng:126.9244 },
  { name:"ì¹´í˜ ë¹ˆë¸Œë¼ë”ìŠ¤ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 21ê¸¸ 19", lat:37.5531, lng:126.9234 },
  { name:"ì•¤íŠ¸ëŸ¬ì‚¬ì´íŠ¸ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í† ì •ë¡œ 111", lat:37.5513, lng:126.9179 },
  { name:"ì¹´í˜ ë§ˆë¦¬ì•„ì¥¬ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 53", lat:37.5522, lng:126.9230 },
  { name:"í™€ì¸ì»¤í”¼ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ìš¸ë§ˆë‹¹ë¡œ 62", lat:37.5553, lng:126.9224 },
  { name:"ì»¤í”¼í•œì•½ë°©", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ6ê¸¸ 7", lat:37.5567, lng:126.9213 },
  { name:"ì¹´í˜ ë ˆì´ì–´ë“œ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ29ê¸¸ 22", lat:37.5540, lng:126.9247 },
  { name:"ìŠ¤íƒ€ë²…ìŠ¤ í™ëŒ€ì ", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 188", lat:37.5572, lng:126.9245 },
  { name:"ì¹´í˜ ì–´ë‹ˆì–¸ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 33", lat:37.5518, lng:126.9228 },
  { name:"ì»¤í”¼í”„ë¦°ìŠ¤ 1í˜¸ì ", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 39", lat:37.5524, lng:126.9231 },
  { name:"ì¹´í˜ ë£¨ë‚˜í‹±", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ 15", lat:37.5561, lng:126.9218 },
  { name:"ë“œë¡­íƒ‘ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ìš¸ë§ˆë‹¹ë¡œ 77", lat:37.5558, lng:126.9230 },
  { name:"ì¹´í˜ ë“œíŒŒìš´ë“œ", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 76", lat:37.5549, lng:126.9241 },
  { name:"ë¸”ë™ì—…ì»¤í”¼ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ4ê¸¸ 13", lat:37.5565, lng:126.9210 },
  { name:"ì¹´í˜ ì•Œë ˆê·¸ë¦¬ì•„", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 61", lat:37.5527, lng:126.9236 },
  { name:"ì»¤í”¼ìŠ¤ë¯¸ìŠ¤ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 168", lat:37.5568, lng:126.9238 },
  { name:"ì¹´í˜ í•˜í”„ì•¤í•˜í”„", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ 8", lat:37.5557, lng:126.9215 },
  { name:"ì˜¨ë”í…Œì´ë¸” í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 44", lat:37.5521, lng:126.9233 },
  { name:"ì¹´í˜ ì„ ìƒ¤ì¸", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ìš¸ë§ˆë‹¹ë¡œ 88", lat:37.5562, lng:126.9235 },
  { name:"ì¹´í˜ ì†Œì „ì„œë¦¼", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 17", lat:37.5528, lng:126.9226 },
  { name:"ë¸Œë¼ìš´í•¸ì¦ˆ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ 23", lat:37.5563, lng:126.9221 },
  { name:"ì¹´í˜ ë‹¬", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 82", lat:37.5551, lng:126.9243 },
  { name:"ë§¤ë‰´íŒ©íŠ¸ì»¤í”¼ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 162", lat:37.5566, lng:126.9234 },
  { name:"ì¹´í˜ ì—ê·¸ìŠ¬ëŸ¿ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 51", lat:37.5523, lng:126.9232 },
  { name:"ì»¤í”¼ í´ëŸ½ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ2ê¸¸ 6", lat:37.5559, lng:126.9207 },
  { name:"ì¹´í˜ ë² ì¼€ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ 67", lat:37.5533, lng:126.9238 },
  { name:"ì•„ìš°ì–´ ë² ì´ì»¤ë¦¬ í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ìš¸ë§ˆë‹¹ë¡œ 100", lat:37.5564, lng:126.9238 },
  { name:"ì¹´í˜ íŠ¸ëŸ­ìŠ¤í„° í™ëŒ€", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ í™ìµë¡œ 31", lat:37.5565, lng:126.9224 },
  { name:"í´ë°”ì…‹ í™ëŒ€ì ", area:"í™ëŒ€", address:"ì„œìš¸ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 174", lat:37.5570, lng:126.9241 },
];

// ============================================================
// STATE
// ============================================================
const ARRIVAL_DISTANCE = 200;
const NEAR_DISTANCE = 50;

let targetPlace = null;
let userLat = null, userLng = null;
let deviceHeading = 0;
let smoothedAngle = 0;
let currentDisplayAngle = 0;
let arrowAnimFrame = null;
let watchId = null;
let simulInterval = null;
let arrived = false;
let nearAlerted = false;
let selectedRadius = 1000;
let destVisible = false;
let nearNameVisible = false;
let toastT = null;

// ============================================================
// RADIUS SELECT
// ============================================================
function selectRadius(btn) {
  document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedRadius = parseInt(btn.dataset.r);
}

// ============================================================
// START
// ============================================================
async function startGame() {
  showLoading(true, 'GPS ìœ„ì¹˜ í™•ì¸ ì¤‘...');
  try {
    const pos = await getPosition();
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
  } catch(e) {
    showLoading(false);
    showToast('ğŸ“ GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”');
    return;
  }

  // ì„ íƒí•œ ë°˜ê²½ ì•ˆì— ìˆëŠ” ì¹´í˜ í•„í„°
  const nearby = CAFES.filter(c => haversine(userLat, userLng, c.lat, c.lng) <= selectedRadius);

  if (nearby.length === 0) {
    showLoading(false);
    showToast(`ë°˜ê²½ ${selectedRadius/1000}km ë‚´ ì¹´í˜ê°€ ì—†ì–´ìš”. ë°˜ê²½ì„ ëŠ˜ë ¤ë³´ì„¸ìš”!`);
    return;
  }

  targetPlace = nearby[Math.floor(Math.random() * nearby.length)];
  nearAlerted = false;
  nearNameVisible = false;
  destVisible = false;

  showLoading(false);
  showScreen('game-screen');

  // Reset UI
  document.getElementById('near-alert').style.display = 'none';
  document.getElementById('near-name-box').style.display = 'none';
  document.getElementById('near-reveal-btn').style.display = 'block';
  document.getElementById('near-reveal-btn').textContent = 'â˜• ì¹´í˜ ì´ë¦„ ë³´ê¸°';
  document.getElementById('dest-box').style.display = 'none';
  document.getElementById('test-toggle-btn').textContent = 'ğŸ” ëª©ì ì§€ ë³´ê¸°';
  document.getElementById('test-toggle-btn').classList.remove('revealed');

  startWatch();
  requestCompass();
  updateUI();
}

// ============================================================
// GPS
// ============================================================
function getPosition() {
  return new Promise((res, rej) => {
    if (!navigator.geolocation) { rej(new Error('no-geo')); return; }
    navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 });
  });
}

function startWatch() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(
    pos => { userLat = pos.coords.latitude; userLng = pos.coords.longitude; updateUI(); },
    () => showToast('GPS ì‹ í˜¸ê°€ ì•½í•´ìš”'),
    { enableHighAccuracy: true, maximumAge: 1000 }
  );
}

// ============================================================
// COMPASS
// ============================================================
function requestCompass() {
  const listen = () => {
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true);
  };
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    document.getElementById('compass-btn').style.display = 'block';
    document.getElementById('hint-text').style.display = 'none';
  } else {
    listen();
    document.getElementById('compass-btn').style.display = 'none';
    document.getElementById('hint-text').style.display = 'block';
  }
  simulInterval = setInterval(() => { deviceHeading = (deviceHeading + 0.35) % 360; }, 50);
}

function askCompassPermission() {
  DeviceOrientationEvent.requestPermission()
    .then(r => {
      if (r === 'granted') {
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
        document.getElementById('compass-btn').style.display = 'none';
        document.getElementById('hint-text').style.display = 'block';
        if (simulInterval) { clearInterval(simulInterval); simulInterval = null; }
      } else {
        showToast('ë‚˜ì¹¨ë°˜ ê¶Œí•œì´ ê±°ë¶€ëì–´ìš” ã… ã… ');
      }
    })
    .catch(() => showToast('ë‚˜ì¹¨ë°˜ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨'));
}

function handleOrientation(e) {
  let h = null;
  if (e.webkitCompassHeading != null) h = e.webkitCompassHeading;
  else if (e.absolute && e.alpha != null) h = (360 - e.alpha) % 360;
  else if (e.alpha != null) h = (360 - e.alpha) % 360;
  if (h != null) {
    let diff = h - deviceHeading;
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;
    deviceHeading = (deviceHeading + diff * 0.2 + 360) % 360;
  }
}

// ============================================================
// MATH
// ============================================================
function haversine(a, b, c, d) {
  const R=6371000, dL=(c-a)*Math.PI/180, dG=(d-b)*Math.PI/180;
  const x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function bearing(a, b, c, d) {
  const dG=(d-b)*Math.PI/180;
  const y=Math.sin(dG)*Math.cos(c*Math.PI/180);
  const x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos(dG);
  return ((Math.atan2(y,x)*180/Math.PI)+360)%360;
}

// ============================================================
// UI UPDATE
// ============================================================
function updateUI() {
  if (!userLat || !targetPlace || arrived) return;
  const dist = haversine(userLat, userLng, targetPlace.lat, targetPlace.lng);

  document.getElementById('dist-value').textContent = dist < 1000 ? Math.round(dist) : (dist/1000).toFixed(1);
  document.getElementById('dist-unit').textContent = dist < 1000 ? ' m' : ' km';

  // 50m ê·¼ì ‘ ì•Œë¦¼
  if (dist <= NEAR_DISTANCE && !nearAlerted && !arrived) {
    nearAlerted = true;
    showNearAlert();
  }

  // 200m ë„ì°©
  if (dist <= ARRIVAL_DISTANCE) showArrival();
}

// Arrow animation loop
function startArrowLoop() {
  if (arrowAnimFrame) cancelAnimationFrame(arrowAnimFrame);
  function loop() {
    if (!userLat || !targetPlace || arrived) { arrowAnimFrame = requestAnimationFrame(loop); return; }
    const targetAngle = bearing(userLat, userLng, targetPlace.lat, targetPlace.lng) - deviceHeading;
    let diff = targetAngle - currentDisplayAngle;
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;
    currentDisplayAngle += diff * 0.12;
    document.getElementById('arrow-container').style.transform = `rotate(${currentDisplayAngle}deg)`;
    arrowAnimFrame = requestAnimationFrame(loop);
  }
  loop();
}

// ============================================================
// 50m NEAR ALERT
// ============================================================
function showNearAlert() {
  const alert = document.getElementById('near-alert');
  alert.style.display = 'flex';
  // ì§„ë™ (Android ì§€ì›)
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

function toggleNearName() {
  nearNameVisible = !nearNameVisible;
  const box = document.getElementById('near-name-box');
  const btn = document.getElementById('near-reveal-btn');
  if (nearNameVisible && targetPlace) {
    box.innerHTML = `â˜• ${targetPlace.name}<br><span style="font-family:'Space Mono',monospace;font-size:0.6rem;color:rgba(74,222,128,0.6)">${targetPlace.area} Â· ${targetPlace.address}</span>`;
    box.style.display = 'block';
    btn.textContent = 'ğŸ™ˆ ìˆ¨ê¸°ê¸°';
  } else {
    box.style.display = 'none';
    btn.textContent = 'â˜• ì¹´í˜ ì´ë¦„ ë³´ê¸°';
  }
}

// ============================================================
// TEST TOGGLE
// ============================================================
function toggleDestination() {
  destVisible = !destVisible;
  const box = document.getElementById('dest-box');
  const btn = document.getElementById('test-toggle-btn');
  if (destVisible && targetPlace) {
    box.innerHTML = `ğŸ“ ${targetPlace.name}<span class="dest-addr">${targetPlace.area} Â· ${targetPlace.address}</span>`;
    box.style.display = 'block';
    btn.textContent = 'ğŸ™ˆ ìˆ¨ê¸°ê¸°';
    btn.classList.add('revealed');
  } else {
    box.style.display = 'none';
    btn.textContent = 'ğŸ” ëª©ì ì§€ ë³´ê¸°';
    btn.classList.remove('revealed');
  }
}

// ============================================================
// ARRIVAL
// ============================================================
function showArrival() {
  arrived = true;
  if (watchId) navigator.geolocation.clearWatch(watchId);
  if (simulInterval) clearInterval(simulInterval);
  if (arrowAnimFrame) cancelAnimationFrame(arrowAnimFrame);
  document.getElementById('near-alert').style.display = 'none';

  document.getElementById('place-name-reveal').textContent = targetPlace.name;
  document.getElementById('place-address-reveal').textContent = targetPlace.area + ' Â· ' + targetPlace.address;

  showScreen('arrival-screen');
  launchConfetti();
}

function openMaps() {
  if (!targetPlace) return;
  window.open(`https://maps.google.com/?q=${targetPlace.lat},${targetPlace.lng}`, '_blank');
}

function restartGame() {
  arrived = false;
  nearAlerted = false;
  stopConfetti();
  document.getElementById('near-alert').style.display = 'none';
  if (arrowAnimFrame) cancelAnimationFrame(arrowAnimFrame);
  showScreen('start-screen');
}

// ============================================================
// HELPERS
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.toggle('active', s.id === id);
  });
  if (id === 'game-screen') startArrowLoop();
}

function showLoading(show, txt) {
  document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
  if (txt) document.getElementById('loader-text').textContent = txt;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  if (toastT) clearTimeout(toastT);
  toastT = setTimeout(() => t.style.display = 'none', 3200);
}

// ============================================================
// CONFETTI
// ============================================================
let confettiAF = null, particles = [];

function launchConfetti() {
  const cv = document.getElementById('confetti-canvas');
  const ctx = cv.getContext('2d');
  cv.width = window.innerWidth; cv.height = window.innerHeight;
  const colors = ['#ff3c5f','#f5c842','#fff','#ff9500','#ff6b9d'];
  particles = Array.from({length:130}, () => ({
    x:Math.random()*cv.width, y:-10,
    vx:(Math.random()-.5)*3, vy:Math.random()*4+2,
    sz:Math.random()*8+4, col:colors[Math.floor(Math.random()*colors.length)],
    rot:Math.random()*360, rs:(Math.random()-.5)*5,
  }));
  (function draw() {
    ctx.clearRect(0,0,cv.width,cv.height);
    particles.forEach(p=>{
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle=p.col; ctx.fillRect(-p.sz/2,-p.sz/4,p.sz,p.sz/2);
      ctx.restore();
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.rs;
      if(p.y>cv.height){p.y=-10;p.x=Math.random()*cv.width;}
    });
    confettiAF = requestAnimationFrame(draw);
  })();
}

function stopConfetti() {
  if (confettiAF) cancelAnimationFrame(confettiAF);
  const cv = document.getElementById('confetti-canvas');
  cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
  particles=[];
}
</script>
</body>
</html>
