<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ë°ì´íŠ¸ ë‚˜ì¹¨ë°˜</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=Space+Mono:wght@400;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --accent: #ff3c5f;
    --gold: #f5c842;
    --text: #e8e4dc;
    --muted: #4a4860;
    --glow: rgba(255,60,95,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    user-select: none;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,60,95,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,60,95,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
  }

  /* ---- API KEY SCREEN ---- */
  #apikey-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 22px;
    z-index: 10;
    padding: 32px 24px;
    text-align: center;
    width: 100%;
    max-width: 360px;
  }

  .logo { font-size: 2.2rem; }

  .screen-title {
    font-family: 'Nanum Myeongjo', serif;
    font-size: 1.55rem;
    font-weight: 700;
    line-height: 1.35;
  }
  .screen-title span { color: var(--accent); }

  .api-desc {
    font-size: 0.7rem;
    color: var(--muted);
    line-height: 1.9;
  }

  .api-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--muted);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    padding: 14px 16px;
    outline: none;
    transition: border 0.2s;
    letter-spacing: 0.04em;
  }
  .api-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(255,60,95,0.15); }
  .api-input::placeholder { color: var(--muted); }

  .api-hint {
    font-size: 0.62rem;
    color: var(--muted);
    text-align: left;
    width: 100%;
    line-height: 1.8;
  }
  .api-hint a { color: var(--accent); text-decoration: none; }

  .primary-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    font-family: 'Space Mono', monospace;
    font-size: 0.9rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    padding: 15px 44px;
    cursor: pointer;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
    transition: all 0.2s;
    text-transform: uppercase;
    width: 100%;
  }
  .primary-btn:hover { background: #ff1a40; box-shadow: 0 0 24px var(--glow); }

  .skip-btn {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    padding: 10px 24px;
    cursor: pointer;
    clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
    transition: all 0.2s;
    text-transform: uppercase;
    width: 100%;
  }
  .skip-btn:hover { color: var(--text); border-color: var(--text); }

  .divider {
    display: flex; align-items: center; gap: 12px; width: 100%;
  }
  .divider::before, .divider::after { content:''; flex:1; height:1px; background:var(--muted); opacity:.3; }
  .divider span { font-size: 0.58rem; color: var(--muted); letter-spacing: 0.1em; }

  /* ---- START SCREEN ---- */
  #start-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 26px;
    z-index: 10;
    padding: 24px;
    text-align: center;
  }

  .heart-icon { font-size: 2.8rem; animation: heartbeat 1.5s ease-in-out infinite; }
  @keyframes heartbeat { 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }

  .title-ko {
    font-family: 'Nanum Myeongjo', serif;
    font-size: clamp(2rem, 8vw, 3.2rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.15;
  }
  .title-ko span { color: var(--accent); }

  .subtitle-sm { font-size: 0.62rem; color: var(--muted); letter-spacing: 0.18em; text-transform: uppercase; }
  .desc { font-size: 0.75rem; color: var(--muted); max-width: 280px; line-height: 1.9; }

  .category-wrap { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 280px; }
  .category-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.18em; text-transform: uppercase; text-align: left; }
  .category-chips { display: flex; flex-wrap: wrap; gap: 8px; }

  .chip {
    background: var(--surface);
    border: 1px solid var(--muted);
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.07em;
    padding: 7px 14px;
    cursor: pointer;
    clip-path: polygon(5px 0%, 100% 0%, calc(100% - 5px) 100%, 0% 100%);
    transition: all 0.15s;
  }
  .chip.active { background: rgba(255,60,95,0.15); border-color: var(--accent); color: var(--accent); }

  /* ---- GAME SCREEN ---- */
  #game-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    height: 100dvh;
    width: 100%;
    padding: 40px 24px 48px;
    z-index: 10;
  }

  .top-info { display: flex; flex-direction: column; align-items: center; gap: 6px; }

  .distance-display {
    font-size: clamp(2.5rem, 12vw, 4rem);
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
  }
  .distance-display .unit { font-size: 0.4em; color: var(--muted); letter-spacing: 0.1em; }
  .distance-label { font-size: 0.62rem; color: var(--muted); letter-spacing: 0.2em; text-transform: uppercase; }

  .status-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
    display: inline-block; margin-right: 6px;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

  .compass-wrap {
    position: relative;
    width: min(280px, 75vw);
    height: min(280px, 75vw);
    display: flex; align-items: center; justify-content: center;
  }
  .compass-ring { position: absolute; inset: 0; border-radius: 50%; border: 1px solid rgba(255,60,95,0.2); }
  .compass-ring::before { content:''; position:absolute; inset:12px; border-radius:50%; border:1px solid rgba(255,60,95,0.1); }

  .compass-inner { position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }

  #arrow-container {
    position: absolute;
    width: 100%; height: 100%;
    transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex; align-items: center; justify-content: center;
  }
  .arrow-svg {
    width: 60%; height: 60%;
    filter: drop-shadow(0 0 16px var(--accent)) drop-shadow(0 0 32px rgba(255,60,95,0.3));
  }
  .center-dot { position:absolute; width:10px; height:10px; background:var(--gold); border-radius:50%; box-shadow:0 0 8px var(--gold); z-index:5; }
  .cardinal { position:absolute; font-size:0.62rem; color:var(--muted); letter-spacing:.1em; }
  .cardinal.n { top:4px; left:50%; transform:translateX(-50%); }
  .cardinal.s { bottom:4px; left:50%; transform:translateX(-50%); }
  .cardinal.e { right:4px; top:50%; transform:translateY(-50%); }
  .cardinal.w { left:4px; top:50%; transform:translateY(-50%); }

  .bottom-info { display:flex; flex-direction:column; align-items:center; gap:10px; }
  .permission-banner { font-size:0.62rem; color:var(--gold); letter-spacing:.08em; text-align:center; max-width:260px; line-height:1.7; display:none; }
  .hint-text { font-size:0.62rem; color:var(--muted); letter-spacing:.15em; text-transform:uppercase; }

  /* ---- LOADING ---- */
  #loading-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(10,10,15,0.92);
    z-index: 50;
    flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  }
  .loader-ring { width:56px; height:56px; border:2px solid var(--muted); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loader-text { font-size:0.7rem; color:var(--muted); letter-spacing:.15em; text-transform:uppercase; }

  /* ---- TOAST ---- */
  #toast {
    display: none;
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: rgba(255,60,95,0.15); border: 1px solid var(--accent); color: var(--accent);
    font-size: 0.65rem; letter-spacing: .1em; padding: 10px 20px;
    z-index: 100; white-space: nowrap;
  }

  /* ---- ARRIVAL SCREEN ---- */
  #arrival-screen {
    display: none;
    flex-direction: column; align-items: center; gap: 18px;
    z-index: 10; padding: 32px; text-align: center;
  }
  .arrival-emoji { font-size: 3.2rem; }
  .arrival-title { font-family:'Nanum Myeongjo',serif; font-size:clamp(1.8rem,7vw,2.8rem); font-weight:700; color:var(--gold); text-shadow:0 0 24px rgba(245,200,66,0.4); line-height:1.2; }
  .place-badge { font-size:.6rem; color:var(--accent); letter-spacing:.2em; text-transform:uppercase; border:1px solid var(--accent); padding:5px 14px; clip-path:polygon(5px 0%,100% 0%,calc(100% - 5px) 100%,0% 100%); }
  .place-reveal { font-family:'Nanum Myeongjo',serif; font-size:clamp(1.4rem,5.5vw,2.2rem); color:var(--text); line-height:1.3; }
  .place-rating { font-size:.8rem; color:var(--gold); letter-spacing:.05em; }
  .place-address { font-size:.65rem; color:var(--muted); max-width:280px; line-height:1.8; }

  .btn-row { display:flex; gap:10px; width:100%; max-width:300px; }
  .outline-btn {
    flex:1; background:transparent; color:var(--accent); border:1px solid var(--accent);
    font-family:'Space Mono',monospace; font-size:.7rem; font-weight:700; letter-spacing:.12em;
    padding:12px; cursor:pointer; text-transform:uppercase;
    clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);
    transition:all .2s;
  }
  .outline-btn:hover { background:var(--accent); color:#fff; box-shadow:0 0 20px var(--glow); }

  #confetti-canvas { position:fixed; inset:0; pointer-events:none; z-index:5; }
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div id="loading-overlay"><div class="loader-ring"></div><div class="loader-text" id="loader-text">ë§›ì§‘ íƒìƒ‰ ì¤‘...</div></div>
<div id="toast"></div>

<!-- API KEY -->
<div id="apikey-screen">
  <div class="logo">ğŸ—ï¸</div>
  <div class="screen-title">Google Places<br><span>API í‚¤</span> ì…ë ¥</div>
  <p class="api-desc">í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ ì‹¤ì œ ë§›ì§‘Â·ëª…ì†Œë¥¼<br>Google Mapsì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ìš”.</p>
  <input class="api-input" id="api-key-input" type="password" placeholder="AIza..." autocomplete="off" spellcheck="false" />
  <div class="api-hint">
    í‚¤ ë°œê¸‰ â†’
    <a href="https://console.cloud.google.com/apis/library/places-backend.googleapis.com" target="_blank">Google Cloud Console</a>
    ì—ì„œ <strong style="color:var(--text)">Places API (New)</strong> í™œì„±í™”<br>
    (ì›” $200 ë¬´ë£Œ í¬ë ˆë”§, ì¹´ë“œ ë“±ë¡ í•„ìš”)
  </div>
  <button class="primary-btn" onclick="saveApiKey()">í‚¤ ì €ì¥ &amp; ì‹œì‘</button>
  <div class="divider"><span>OR</span></div>
  <button class="skip-btn" onclick="skipApiKey()">í‚¤ ì—†ì´ ì„œìš¸ ê¸°ë³¸ ì¥ì†Œë¡œ ì‹œì‘</button>
</div>

<!-- START -->
<div id="start-screen">
  <div class="heart-icon">ğŸ’˜</div>
  <div class="title-ko">ëª°ë˜<br><span>ë°ì´íŠ¸</span><br>ë‚˜ì¹¨ë°˜</div>
  <p class="desc">ëª©ì ì§€ëŠ” ë¹„ë°€ âœ¦ í™”ì‚´í‘œë§Œ ë¯¿ê³  ê±¸ì–´ê°€ì„¸ìš”</p>

  <div class="category-wrap">
    <div class="category-label">ì–´ë–¤ ê³³ìœ¼ë¡œ ê°ˆê¹Œìš”?</div>
    <div class="category-chips" id="category-chips">
      <div class="chip active" data-type="restaurant">ğŸ½ ë§›ì§‘</div>
      <div class="chip active" data-type="cafe">â˜• ì¹´í˜</div>
      <div class="chip active" data-type="tourist_attraction">ğŸ› ëª…ì†Œ</div>
      <div class="chip active" data-type="park">ğŸŒ¿ ê³µì›</div>
    </div>
  </div>

  <button class="primary-btn" onclick="startGame()" style="max-width:280px">ì¶œë°œí•˜ê¸° â†’</button>
  <div class="subtitle-sm">GPS Â· ë‚˜ì¹¨ë°˜ í•„ìš”</div>
</div>

<!-- GAME -->
<div id="game-screen">
  <div class="top-info">
    <div class="distance-display">
      <span id="dist-value">---</span><span class="unit" id="dist-unit"> m</span>
    </div>
    <div class="distance-label"><span class="status-dot"></span>ëª©ì ì§€ê¹Œì§€</div>
  </div>

  <div class="compass-wrap">
    <div class="compass-ring"></div>
    <div class="compass-inner">
      <span class="cardinal n">N</span>
      <span class="cardinal s">S</span>
      <span class="cardinal e">E</span>
      <span class="cardinal w">W</span>
      <div id="arrow-container">
        <svg class="arrow-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <polygon points="50,8 62,55 50,48 38,55" fill="#ff3c5f"/>
          <polygon points="50,92 62,55 50,62 38,55" fill="#2a1020"/>
          <circle cx="50" cy="55" r="6" fill="#ff3c5f" opacity="0.5"/>
        </svg>
      </div>
      <div class="center-dot"></div>
    </div>
  </div>

  <div class="bottom-info">
    <button id="compass-btn" onclick="askCompassPermission()" style="
      display:none;
      background: rgba(255,60,95,0.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      font-family: 'Space Mono', monospace;
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      padding: 14px 28px;
      cursor: pointer;
      clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
    ">ğŸ“± ì—¬ê¸° ëˆŒëŸ¬ì„œ ë‚˜ì¹¨ë°˜ í—ˆìš©</button>
    <div class="hint-text" id="hint-text" style="display:none">í™”ì‚´í‘œ ë°©í–¥ìœ¼ë¡œ ê±¸ì–´ê°€ì„¸ìš”</div>
  </div>
</div>

<!-- ARRIVAL -->
<div id="arrival-screen">
  <div class="arrival-emoji">ğŸ‰</div>
  <div class="arrival-title">ë„ì°©í–ˆì–´ìš”!</div>
  <div class="place-badge" id="place-type-reveal"></div>
  <div class="place-reveal" id="place-name-reveal"></div>
  <div class="place-rating" id="place-rating-reveal"></div>
  <div class="place-address" id="place-address-reveal"></div>
  <div class="btn-row">
    <button class="outline-btn" onclick="openMaps()">ì§€ë„ ë³´ê¸°</button>
    <button class="outline-btn" onclick="restartGame()">ë‹¤ì‹œ ë½‘ê¸°</button>
  </div>
</div>

<script>
// ============================================================
// CONSTANTS
// ============================================================
const ARRIVAL_DISTANCE = 200;
const SEARCH_RADIUS = 2000;
const MAX_RESULTS = 20;

// Fallback: Seoul famous spots
const FALLBACK = [
  { name:"ê´‘ì¥ì‹œì¥", type:"ì „í†µì‹œì¥ ë¨¹ê±°ë¦¬", lat:37.5700, lng:126.9997, address:"ì„œìš¸ ì¢…ë¡œêµ¬ ì¢…ë¡œ 88" },
  { name:"ìµì„ ë™ í•œì˜¥ë§ˆì„", type:"ë ˆíŠ¸ë¡œ ì¹´í˜ ê³¨ëª©", lat:37.5726, lng:126.9940, address:"ì„œìš¸ ì¢…ë¡œêµ¬ ìµì„ ë™" },
  { name:"ì„±ìˆ˜ë™ ì¹´í˜ê±°ë¦¬", type:"í™í•œ ì¹´í˜", lat:37.5444, lng:127.0557, address:"ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ë™" },
  { name:"ê²½ë³µê¶", type:"ê³ ê¶ ì‚°ì±…", lat:37.5796, lng:126.9770, address:"ì„œìš¸ ì¢…ë¡œêµ¬ ì‚¬ì§ë¡œ 161" },
  { name:"ë‚¨ì‚° ì„œìš¸íƒ€ì›Œ", type:"ì•¼ê²½ ëª…ì†Œ", lat:37.5512, lng:126.9882, address:"ì„œìš¸ ìš©ì‚°êµ¬ ë‚¨ì‚°ê³µì›ê¸¸ 105" },
  { name:"ì„œìš¸ìˆ²", type:"ë„ì‹¬ ê³µì› í”¼í¬ë‹‰", lat:37.5444, lng:127.0372, address:"ì„œìš¸ ì„±ë™êµ¬ ëšì„¬ë¡œ 273" },
  { name:"í™ëŒ€ ìƒìƒë§ˆë‹¹", type:"ë¬¸í™”ë³µí•©ê³µê°„", lat:37.5530, lng:126.9230, address:"ì„œìš¸ ë§ˆí¬êµ¬ ì”ë‹¤ë¦¬ë¡œ 35" },
  { name:"DDP ë™ëŒ€ë¬¸ë””ìì¸í”Œë¼ì", type:"ê±´ì¶• ì•¼ê²½ ëª…ì†Œ", lat:37.5672, lng:127.0089, address:"ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 281" },
  { name:"ë¶ì´Œ í•œì˜¥ë§ˆì„", type:"ì „í†µ ê±°ë¦¬ ì‚°ì±…", lat:37.5822, lng:126.9830, address:"ì„œìš¸ ì¢…ë¡œêµ¬ ê³„ë™ê¸¸ 37" },
  { name:"í•œê°• ëšì„¬ìœ ì›ì§€", type:"í•œê°• í”¼í¬ë‹‰", lat:37.5300, lng:127.0671, address:"ì„œìš¸ ê´‘ì§„êµ¬ ëšì„¬ë¡œ 262" },
  { name:"ë§ì›ë™ ë¨¹ìê³¨ëª©", type:"í•«í”Œ ë¨¹ê±°ë¦¬", lat:37.5556, lng:126.9054, address:"ì„œìš¸ ë§ˆí¬êµ¬ ë§ì›ë™" },
  { name:"ì„ì§€ë¡œ ë…¸ê°€ë¦¬ ê³¨ëª©", type:"ê°ì„± í¬ì°¨ ê±°ë¦¬", lat:37.5661, lng:126.9917, address:"ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ" },
  { name:"ì¸ì‚¬ë™ ìŒˆì§€ê¸¸", type:"ê³µì˜ˆ & ê°¤ëŸ¬ë¦¬", lat:37.5724, lng:126.9866, address:"ì„œìš¸ ì¢…ë¡œêµ¬ ì¸ì‚¬ë™ê¸¸ 44" },
  { name:"ë…¸ì„ê³µì›", type:"ë…¸ì„ ê°ìƒ ëª…ì†Œ", lat:37.5667, lng:126.8750, address:"ì„œìš¸ ë§ˆí¬êµ¬ í•˜ëŠ˜ê³µì›ë¡œ 95" },
  { name:"ì°½ë•ê¶ í›„ì›", type:"ë¹„ë°€ì˜ ì •ì›", lat:37.5812, lng:126.9916, address:"ì„œìš¸ ì¢…ë¡œêµ¬ ìœ¨ê³¡ë¡œ 99" },
];

// ============================================================
// STATE
// ============================================================
let apiKey = '';
let useApi = false;
let targetPlace = null;
let userLat = null, userLng = null;
let deviceHeading = 0;
let watchId = null;
let arrived = false;
let selectedCategories = ['restaurant','cafe','tourist_attraction','park'];
let simulInterval = null;

// ============================================================
// API KEY
// ============================================================
function saveApiKey() {
  const val = document.getElementById('api-key-input').value.trim();
  if (!val.startsWith('AIza')) { showToast('ì˜¬ë°”ë¥¸ API í‚¤ê°€ ì•„ë‹ˆì—ìš” (AIzaë¡œ ì‹œì‘í•´ì•¼ í•´ìš”)'); return; }
  apiKey = val;
  useApi = true;
  showScreen('start-screen');
}

function skipApiKey() {
  useApi = false;
  showScreen('start-screen');
}

// ============================================================
// CATEGORY CHIPS
// ============================================================
document.getElementById('category-chips').addEventListener('click', e => {
  const chip = e.target.closest('.chip');
  if (!chip) return;
  chip.classList.toggle('active');
  const t = chip.dataset.type;
  selectedCategories = chip.classList.contains('active')
    ? [...new Set([...selectedCategories, t])]
    : selectedCategories.filter(c => c !== t);
});

// ============================================================
// START
// ============================================================
async function startGame() {
  if (selectedCategories.length === 0) { showToast('ì¹´í…Œê³ ë¦¬ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

  showLoading(true, 'GPS ìœ„ì¹˜ í™•ì¸ ì¤‘...');
  try {
    const pos = await getPosition();
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
  } catch(e) {
    showLoading(false);
    showToast('ğŸ“ GPS ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”');
    return;
  }

  let places = [];
  if (useApi && apiKey) {
    showLoading(true, 'ì£¼ë³€ ë§›ì§‘ íƒìƒ‰ ì¤‘...');
    places = await fetchNearby(userLat, userLng);
  }
  if (places.length === 0) places = [...FALLBACK];

  targetPlace = places[Math.floor(Math.random() * places.length)];
  showLoading(false);
  showScreen('game-screen');
  startWatch();
  requestCompass();
  updateUI();
}

// ============================================================
// GOOGLE PLACES API (New â€” Nearby Search v1)
// ============================================================
async function fetchNearby(lat, lng) {
  const typeMap = { restaurant:'restaurant', cafe:'cafe', tourist_attraction:'tourist_attraction', park:'park' };
  const includedTypes = selectedCategories.map(c => typeMap[c]).filter(Boolean);
  if (!includedTypes.length) return [];

  try {
    const res = await fetch('https://places.googleapis.com/v1/places:searchNearby', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Goog-Api-Key': apiKey,
        'X-Goog-FieldMask': 'places.displayName,places.location,places.formattedAddress,places.rating,places.types',
      },
      body: JSON.stringify({
        includedTypes,
        maxResultCount: MAX_RESULTS,
        locationRestriction: {
          circle: { center: { latitude: lat, longitude: lng }, radius: SEARCH_RADIUS }
        },
        languageCode: 'ko',
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      showToast('API ì˜¤ë¥˜: ' + (err.error?.message || res.status) + ' â€” ê¸°ë³¸ ì¥ì†Œë¡œ ì§„í–‰í•´ìš”');
      return [];
    }

    const data = await res.json();
    return (data.places || []).map(p => ({
      name: p.displayName?.text || 'ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ',
      type: translateType(p.types?.[0] || ''),
      lat: p.location.latitude,
      lng: p.location.longitude,
      address: p.formattedAddress || '',
      rating: p.rating ?? null,
    }));
  } catch(e) {
    showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ â€” ê¸°ë³¸ ì¥ì†Œë¡œ ì§„í–‰í•´ìš”');
    return [];
  }
}

const TYPE_MAP = { restaurant:'ë§›ì§‘ ğŸ½', cafe:'ì¹´í˜ â˜•', tourist_attraction:'ëª…ì†Œ ğŸ›', park:'ê³µì› ğŸŒ¿', bar:'ë°” ğŸº', bakery:'ë² ì´ì»¤ë¦¬ ğŸ¥' };
function translateType(t) { return TYPE_MAP[t] || 'ì¥ì†Œ ğŸ“'; }

// ============================================================
// GPS WATCH
// ============================================================
function getPosition() {
  return new Promise((res, rej) => {
    if (!navigator.geolocation) { rej(new Error('no-geo')); return; }
    navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 });
  });
}

function startWatch() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(
    pos => { userLat = pos.coords.latitude; userLng = pos.coords.longitude; updateUI(); },
    () => showToast('GPS ì‹ í˜¸ê°€ ì•½í•´ìš”'),
    { enableHighAccuracy: true, maximumAge: 1000 }
  );
}

// ============================================================
// COMPASS
// ============================================================
function requestCompass() {
  const listen = () => {
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true);
  };

  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    // iOS 13+ â€” ë°˜ë“œì‹œ ì‚¬ìš©ì ì œìŠ¤ì²˜(ë²„íŠ¼ í´ë¦­)ì—ì„œ í˜¸ì¶œí•´ì•¼ í•¨
    // ì¼ë‹¨ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸°
    document.getElementById('compass-btn').style.display = 'block';
    document.getElementById('hint-text').style.display = 'none';
  } else {
    // Android ë“±
    listen();
    document.getElementById('compass-btn').style.display = 'none';
    document.getElementById('hint-text').style.display = 'block';
  }
  // ë°ìŠ¤í¬í†± ì‹œë®¬ë ˆì´ì…˜
  simulInterval = setInterval(() => { deviceHeading = (deviceHeading + 0.35) % 360; updateArrow(); }, 50);
}

function askCompassPermission() {
  DeviceOrientationEvent.requestPermission()
    .then(r => {
      if (r === 'granted') {
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
        document.getElementById('compass-btn').style.display = 'none';
        document.getElementById('hint-text').style.display = 'block';
        if (simulInterval) { clearInterval(simulInterval); simulInterval = null; }
      } else {
        showToast('ë‚˜ì¹¨ë°˜ ê¶Œí•œì´ ê±°ë¶€ëì–´ìš” ã… ã…  Safari ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”');
      }
    })
    .catch(() => showToast('ë‚˜ì¹¨ë°˜ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨'));
}

function handleOrientation(e) {
  let h = null;
  if (e.webkitCompassHeading != null) h = e.webkitCompassHeading;
  else if (e.absolute && e.alpha != null) h = (360 - e.alpha) % 360;
  else if (e.alpha != null) h = (360 - e.alpha) % 360;
  if (h != null) { deviceHeading = h; updateArrow(); }
}

// ============================================================
// MATH
// ============================================================
function haversine(a, b, c, d) {
  const R=6371000, dL=(c-a)*Math.PI/180, dG=(d-b)*Math.PI/180;
  const x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dG/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function bearing(a, b, c, d) {
  const dG=(d-b)*Math.PI/180;
  const y=Math.sin(dG)*Math.cos(c*Math.PI/180);
  const x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos(dG);
  return ((Math.atan2(y,x)*180/Math.PI)+360)%360;
}

// ============================================================
// UI
// ============================================================
function updateUI() {
  if (!userLat || !targetPlace || arrived) return;
  const dist = haversine(userLat, userLng, targetPlace.lat, targetPlace.lng);
  document.getElementById('dist-value').textContent = dist < 1000 ? Math.round(dist) : (dist/1000).toFixed(1);
  document.getElementById('dist-unit').textContent = dist < 1000 ? ' m' : ' km';
  updateArrow();
  if (dist <= ARRIVAL_DISTANCE) showArrival();
}

function updateArrow() {
  if (!userLat || !targetPlace || arrived) return;
  const angle = bearing(userLat, userLng, targetPlace.lat, targetPlace.lng) - deviceHeading;
  document.getElementById('arrow-container').style.transform = `rotate(${angle}deg)`;
}

// ============================================================
// ARRIVAL
// ============================================================
function showArrival() {
  arrived = true;
  if (watchId) navigator.geolocation.clearWatch(watchId);
  if (simulInterval) clearInterval(simulInterval);

  document.getElementById('place-type-reveal').textContent = targetPlace.type || 'ì¥ì†Œ ğŸ“';
  document.getElementById('place-name-reveal').textContent = targetPlace.name;
  document.getElementById('place-address-reveal').textContent = targetPlace.address || '';
  document.getElementById('place-rating-reveal').textContent =
    targetPlace.rating ? 'â­ ' + Number(targetPlace.rating).toFixed(1) + ' / 5.0' : '';

  showScreen('arrival-screen');
  launchConfetti();
}

function openMaps() {
  if (!targetPlace) return;
  window.open(`https://maps.google.com/?q=${targetPlace.lat},${targetPlace.lng}`, '_blank');
}

function restartGame() {
  arrived = false;
  stopConfetti();
  showScreen('start-screen');
}

// ============================================================
// HELPERS
// ============================================================
function showScreen(id) {
  ['apikey-screen','start-screen','game-screen','arrival-screen'].forEach(s => {
    document.getElementById(s).style.display = s === id ? 'flex' : 'none';
  });
}

function showLoading(show, txt) {
  const el = document.getElementById('loading-overlay');
  el.style.display = show ? 'flex' : 'none';
  if (txt) document.getElementById('loader-text').textContent = txt;
}

let toastT = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  if (toastT) clearTimeout(toastT);
  toastT = setTimeout(() => t.style.display = 'none', 3200);
}

// ============================================================
// CONFETTI
// ============================================================
let confettiAF = null, particles = [];

function launchConfetti() {
  const cv = document.getElementById('confetti-canvas');
  const ctx = cv.getContext('2d');
  cv.width = window.innerWidth; cv.height = window.innerHeight;
  const colors = ['#ff3c5f','#f5c842','#fff','#ff9500','#ff6b9d'];
  particles = Array.from({length:130}, () => ({
    x: Math.random()*cv.width, y:-10,
    vx:(Math.random()-.5)*3, vy:Math.random()*4+2,
    sz:Math.random()*8+4, col:colors[Math.floor(Math.random()*colors.length)],
    rot:Math.random()*360, rs:(Math.random()-.5)*5,
  }));
  (function draw() {
    ctx.clearRect(0,0,cv.width,cv.height);
    particles.forEach(p=>{
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle=p.col; ctx.fillRect(-p.sz/2,-p.sz/4,p.sz,p.sz/2);
      ctx.restore();
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.rs;
      if(p.y>cv.height){p.y=-10;p.x=Math.random()*cv.width;}
    });
    confettiAF = requestAnimationFrame(draw);
  })();
}

function stopConfetti() {
  if (confettiAF) cancelAnimationFrame(confettiAF);
  const cv = document.getElementById('confetti-canvas');
  cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
  particles=[];
}
</script>
</body>
</html>
